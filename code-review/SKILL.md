---
name: code-review
description: 自动检查 git 暂存区代码改动的潜在风险和问题。当用户请求进行代码审查、提交前检查、review 改动、检查暂存区代码时使用。能识别类型安全问题、逻辑风险、调试代码残留、测试覆盖遗漏、性能隐患和安全漏洞，并提供风险等级评估和改进建议。
---

# Code Review

自动化代码审查工具,检查 git 暂存区的改动并识别潜在问题。

## 审查流程

### 1. 获取暂存区改动

执行以下命令获取改动内容:

```bash
git diff --cached
```

如果暂存区为空,提示用户先使用 `git add` 暂存要审查的文件。

### 2. 分析改动内容

对获取的 diff 内容进行系统化检查,关注:

**文件级别**:
- 新增/删除/修改的文件类型
- 文件路径是否合理
- 是否涉及关键配置文件

**代码级别**:
- 具体的代码变更
- 删除的代码(可能影响功能)
- 新增的代码(可能引入问题)

### 3. 多维度风险检查

按以下维度进行检查,根据项目技术栈选择相关检查项:

#### 🔒 类型安全 (TypeScript/JavaScript)

- `any` 类型滥用
- 类型断言过度使用
- 非空断言操作符 `!` 危险使用
- 缺少类型注解
- Promise 类型不明确
- **详见**: `references/typescript-risks.md` (TypeScript 项目必读)

#### 🧠 逻辑风险

- 条件判断变更(可能改变业务逻辑)
- 循环边界条件修改
- 异步流程变更
- 错误处理被删除或弱化
- 默认值或初始值变更
- 状态管理逻辑修改

#### 🐛 调试代码残留

- `console.log/debug/info/warn` 语句
- `debugger` 断点
- 测试用的硬编码数据
- 临时注释掉的代码
- `TODO` 或 `FIXME` 标记(评估是否应该解决)

#### 🧪 测试覆盖

- 新增功能是否有对应测试
- 修改的函数是否需要更新测试
- 删除功能是否清理了相关测试
- 边界情况测试是否充分

#### 🎨 代码规范

- 未使用的导入
- 未使用的变量/函数
- 代码格式不一致
- 命名不规范
- 注释缺失或过时

#### ⚡ 性能隐患

- 不必要的重渲染(React `useEffect` 依赖)
- 大量数据处理未优化
- 同步操作阻塞
- 内存泄漏风险(事件监听器未清理)
- 循环内的昂贵操作

#### 🔐 安全问题

- 敏感信息硬编码(密钥、密码、token)
- SQL 注入风险
- XSS 风险(未转义的用户输入)
- CSRF 防护缺失
- 不安全的依赖版本

### 4. 输出审查报告

按以下格式组织输出:

```markdown
# 📊 代码审查报告

## 📁 改动概览
- 修改文件数: X
- 新增行数: +XXX
- 删除行数: -XXX
- 主要变更: [简要描述]

## 🔍 发现的问题

### 🚨 Critical (严重)
影响系统稳定性、安全性或核心功能的问题

**[问题 1 标题]**
- **文件**: `path/to/file.ts:123`
- **问题**: [具体描述]
- **风险**: [为什么这是问题]
- **建议**: [如何修复]

### ⚠️ High (高)
可能导致 bug 或维护困难的问题

### 💡 Medium (中)
代码质量或最佳实践相关

### ℹ️ Low (低)
代码风格或微小改进建议

## ✅ 做得好的地方
[列出改动中的优秀实践]

## 📝 总体建议
[综合评估和改进方向]

---
**审查完成时间**: [时间戳]
```

### 5. 风险等级定义

- **Critical 🚨**: 安全漏洞、类型完全不安全、生产环境数据风险、核心逻辑错误
- **High ⚠️**: 可能导致运行时错误、重要逻辑变更未测试、性能严重下降
- **Medium 💡**: 类型不够严格、测试覆盖不足、代码可维护性问题
- **Low ℹ️**: 代码风格、命名建议、非关键注释缺失

## 使用示例

用户可能这样请求:
- "帮我 review 一下暂存区的代码"
- "检查一下我的改动有没有问题"
- "审查这次提交"
- "看看这些改动有什么风险"

## 技术栈特定检查

根据检测到的文件类型,加载对应的详细检查规则:

- **TypeScript/JavaScript**: 阅读 `references/typescript-risks.md`
- **React**: 阅读 `references/react-risks.md`
- **安全相关**: 阅读 `references/security-risks.md`

## 注意事项

1. **上下文理解**: 尽量理解改动的业务背景,避免误报
2. **平衡性**: 不要过于严格导致报告冗长无用
3. **可操作性**: 建议必须具体可执行
4. **优先级**: 先关注 Critical 和 High 级别问题
5. **积极反馈**: 也要指出做得好的地方,不只是挑问题
